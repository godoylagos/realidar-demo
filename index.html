<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='stylesheet' href='css/common.css'>
    <title>Realidar v4</title>
    <style>
      #welcomeScreen {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #000; /* Puedes cambiar a una imagen de fondo */
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      #startExperienceBtn {
        padding: 16px 28px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        background-color: #00ffff;
        color: #000;
        margin-top: 24px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>

    <div id="welcomeScreen">
      <h1>Bienvenido a Realidar Express</h1>
      <p>Detecta el plano, coloca el logo y vive la experiencia.</p>
      <button id="startExperienceBtn">Comenzar experiencia</button>
    </div>

    <div id="xrContainer" style="display: none;">
      <!-- Todo el flujo RA se cargará después -->
      
      <script type="module">
        
        import { Scene } from './js/render/scenes/scene.js';
        import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
        import { Node } from './js/render/core/node.js';
        import { Gltf2Node } from './js/render/nodes/gltf2.js';
        import { DropShadowNode } from './js/render/nodes/drop-shadow.js';
        import { vec3 } from './js/render/math/gl-matrix.js';
        import { Ray } from './js/render/math/ray.js';

        // Reemplaza todo el bloque que usaba WebXRButton con esto:

let xrRefSpace = null;
let xrViewerSpace = null;
let xrHitTestSource = null;

// WebGL scene globals.
let gl = null;
let renderer = null;
let scene = new Scene();
scene.enableStats(false);

let arObject = new Node();
arObject.visible = false;
scene.addNode(arObject);

let flower = new Gltf2Node({url: 'media/gltf/sunflower/sunflower.gltf'});
arObject.addNode(flower);

let reticle = new Gltf2Node({url: 'media/gltf/reticle/reticle.gltf'});
reticle.visible = false;
scene.addNode(reticle);

let shadow = new DropShadowNode();
vec3.set(shadow.scale, 0.15, 0.15, 0.15);
arObject.addNode(shadow);

const MAX_FLOWERS = 30;
let flowers = [];

scene.clear = false;

// Inicia la sesión AR al presionar nuestro botón personalizado
document.getElementById('startButton').addEventListener('click', async () => {
  if (!navigator.xr) {
    alert('WebXR no es compatible en este dispositivo');
    return;
  }

  const supported = await navigator.xr.isSessionSupported('immersive-ar');
  if (!supported) {
    alert('La realidad aumentada no está disponible en este dispositivo');
    return;
  }

  try {
    const session = await navigator.xr.requestSession('immersive-ar', {
      requiredFeatures: ['local', 'hit-test']
    });

    document.getElementById('intro').style.display = 'none'; // Oculta la pantalla de bienvenida

    startARSession(session);
  } catch (e) {
    alert('Error iniciando la experiencia AR: ' + e);
  }
});

function startARSession(session) {
  session.addEventListener('end', () => {
    xrHitTestSource?.cancel();
    xrHitTestSource = null;
  });

  session.addEventListener('select', onSelect);

  if (!gl) {
    gl = createWebGLContext({ xrCompatible: true });
    renderer = new Renderer(gl);
    scene.setRenderer(renderer);
  }

  session.updateRenderState({
    baseLayer: new XRWebGLLayer(session, gl)
  });

  session.requestReferenceSpace('viewer').then((refSpace) => {
    xrViewerSpace = refSpace;
    session.requestHitTestSource({ space: xrViewerSpace }).then((hitTestSource) => {
      xrHitTestSource = hitTestSource;
    });
  });

  session.requestReferenceSpace('local').then((refSpace) => {
    xrRefSpace = refSpace;
    session.requestAnimationFrame((t, f) => onXRFrame(t, f, session));
  });
}

function onSelect(event) {
  if (reticle.visible) {
    addARObjectAt(reticle.matrix);
  }
}

function addARObjectAt(matrix) {
  let newFlower = arObject.clone();
  newFlower.visible = true;
  newFlower.matrix = matrix;
  scene.addNode(newFlower);

  flowers.push(newFlower);

  if (flowers.length > MAX_FLOWERS) {
    let oldFlower = flowers.shift();
    scene.removeNode(oldFlower);
  }
}

function onXRFrame(t, frame, session) {
  let pose = frame.getViewerPose(xrRefSpace);

  reticle.visible = false;

  if (xrHitTestSource && pose) {
    let hitTestResults = frame.getHitTestResults(xrHitTestSource);
    if (hitTestResults.length > 0) {
      let pose = hitTestResults[0].getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix = pose.transform.matrix;
    }
  }

  scene.startFrame();
  session.requestAnimationFrame((t, f) => onXRFrame(t, f, session));
  scene.drawXRFrame(frame, pose);
  scene.endFrame();
}


        initXR();
      </script>
    </div>

    <script>
      document.getElementById('startExperienceBtn').addEventListener('click', () => {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('xrContainer').style.display = 'block';
      });
    </script>
  </body>
</html>
